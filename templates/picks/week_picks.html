{% extends 'base.html' %}
{% load custom_filters %}
{% load static %}


{% block title %}Week {{ week.number }} Picks - Football Picker{% endblock %}

{% block content %}
{% include 'navbar.html' %}

<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>Week {{ week.number }} Picks üèà</h2>
                <div>
                    <a href="{% url 'picks:game_list' %}" class="btn btn-secondary">Back to Games</a>
                    <a href="{% url 'picks:my_picks' %}" class="btn btn-primary">My Picks</a>
                </div>
            </div>

            {% if messages %}
                {% for message in messages %}
                    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                {% endfor %}
            {% endif %}

            <div class="row">
                <div class="col-lg-9">
                    <div class="card">
                        <div class="card-header">
                            <h4 class="mb-0">Make Your Picks</h4>
                            <small class="text-muted">
                                Select the winner for each game and assign confidence points (1-{{ games_count }}).
                                Each confidence value can only be used once.
                            </small>
                        </div>
                        <div class="card-body">
                            <form method="post" id="week-picks-form">
                                {% csrf_token %}
                                
                                <div class="picks-container">
                                    {% for game in games %}
                                    {% with pick=picks_dict|get_item:game.id %}
                                        <div class="game-pick-row mb-4 p-3 border rounded">
                                            <div class="row align-items-center">
                                                <div class="col-md-5">
                                                    <div class="game-info">
                                                        <h5 class="mb-1">
                                                            <span class="away-team">{{ game.away_team.short_name }}</span>
                                                            @
                                                            <span class="home-team">{{ game.home_team.short_name }}</span>
                                                        </h5>
                                                        <small class="text-muted">
                                                            {{ game.game_date|date:"M d, g:i A" }}
                                                        </small>
                                                        {% if game.status != 'SCHEDULED' %}
                                                            <span class="badge bg-warning ms-2">{{ game.status }}</span>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                                
                                                <div class="col-md-4">
                                                    <label class="form-label">Pick Winner:</label>
                                                    <select name="game_{{ game.id }}_team" class="form-select team-select" required 
                                                            {% if game.status != 'SCHEDULED' %}disabled{% endif %}>
                                                        <option value="">Select winner</option>
                                                        <option value="{{ game.away_team.id }}" 
                                                                {% if pick and pick.selected_team == game.away_team %}selected{% endif %}>
                                                            {{ game.away_team.name }} (Away)
                                                        </option>
                                                        <option value="{{ game.home_team.id }}"
                                                                {% if pick and pick.selected_team == game.home_team %}selected{% endif %}>
                                                            {{ game.home_team.name }} (Home)
                                                        </option>
                                                    </select>
                                                </div>
                                                
                                                <div class="col-md-3">
                                                    <label class="form-label">Confidence:</label>
                                                    <input type="number" name="game_{{ game.id }}_confidence" 
                                                        class="form-control confidence-input" 
                                                        min="1" max="{{ games_count }}" 
                                                        placeholder="1-{{ games_count }}"
                                                        value="{% if pick %}{{ pick.confidence_points }}{% endif %}"
                                                        {% if game.status != 'SCHEDULED' %}disabled{% endif %}
                                                        required>
                                                </div>
                                            </div>
                                            
                                            {% if pick %}
                                                <div class="current-pick mt-2">
                                                    <small class="text-success">
                                                        <strong>Current pick:</strong> 
                                                        {{ pick.selected_team.name }} 
                                                        ({{ pick.confidence_points }} points)
                                                    </small>
                                                </div>
                                            {% endif %}
                                        </div>
                                    {% endwith %}
                                    {% endfor %}
                                </div>
                                
                                <div class="text-center mt-4">
                                    <button type="submit" class="btn btn-success btn-lg" id="submit-picks">
                                        Save All Picks
                                    </button>
                                    <div class="mt-2">
                                        <small class="text-muted">
                                            Make sure all games have picks and confidence points 1-{{ games_count }} are each used exactly once.
                                        </small>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                
                <div class="col-lg-3">
                    <div class="card sticky-top" style="top: 20px;">
                        <div class="card-header">
                            <h5 class="mb-0">Confidence Tracker</h5>
                        </div>
                        <div class="card-body">
                            <div id="confidence-tracker">
                                <p class="text-muted">Select confidence points to see which are used.</p>
                                <div class="confidence-grid">
                                        {% for i in games_count|to_range %}
                                            <span class="badge bg-light text-dark confidence-badge" data-value="{{ i }}">{{ i }}</span>
                                        {% endfor %}
                                </div>

                                
                                <div class="mt-3">
                                    <small class="text-muted">
                                        <span class="badge bg-success">Used</span>
                                        <span class="badge bg-light text-dark">Available</span>
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
document.addEventListener("DOMContentLoaded", function () {
    const pointInputs = document.querySelectorAll(".confidence-input");
    const confidenceBadges = document.querySelectorAll(".confidence-badge");

    function updateUsedPoints() {
        const usedPoints = new Set();
        const duplicatePoints = new Set();

        pointInputs.forEach(input => {
            const val = parseInt(input.value);
            if (!isNaN(val)) {
                if (usedPoints.has(val)) {
                    duplicatePoints.add(val);
                } else {
                    usedPoints.add(val);
                }
            }
        });

        // Highlight used confidence points in the tracker
        confidenceBadges.forEach(badge => {
            const point = parseInt(badge.getAttribute("data-value"));
            if (usedPoints.has(point)) {
                badge.classList.remove("bg-light", "text-dark");
                badge.classList.add("bg-success", "text-white");
            } else {
                badge.classList.remove("bg-success", "text-white");
                badge.classList.add("bg-light", "text-dark");
            }
        });

        // Highlight duplicates in inputs
        pointInputs.forEach(input => {
            const val = parseInt(input.value);
            if (!isNaN(val) && duplicatePoints.has(val)) {
                input.classList.add("is-invalid");
            } else {
                input.classList.remove("is-invalid");
            }
        });
    }

    pointInputs.forEach(input => {
        input.addEventListener("change", updateUsedPoints);
        input.addEventListener("keyup", updateUsedPoints);
    });

    updateUsedPoints(); // Run on load
});
</script>

{% endblock %}